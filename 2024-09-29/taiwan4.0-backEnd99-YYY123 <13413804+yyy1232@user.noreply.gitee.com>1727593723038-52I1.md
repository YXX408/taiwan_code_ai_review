# Ai ä»£ç è¯„å®¡.
### ğŸ˜€ä»£ç è¯„åˆ†ï¼š70
#### ğŸ˜€ä»£ç é€»è¾‘ä¸ç›®çš„ï¼š
è¯¥ä»£ç é€šè¿‡è°ƒæ•´å’Œæ‰©å……æœåŠ¡å±‚ã€æ§åˆ¶å™¨å±‚ä»¥åŠæ•°æ®å±‚çš„å®ç°ï¼Œæ·»åŠ å¤„ç†ä»»åŠ¡æ¡ä»¶ã€æä¾›ä»»åŠ¡ç»†èŠ‚ã€æ‰§è¡Œä»»åŠ¡ç­‰åŠŸèƒ½ã€‚å…¶ä¸­åŒ…æ‹¬æ‰©å±•`UserRoleController`å’Œ`UserTaskController`æ¥å¤„ç†ä¸ç”¨æˆ·ä»»åŠ¡ç›¸å…³çš„é€»è¾‘ï¼Œå¢åŠ ä»»åŠ¡å®Œæˆæ¡ä»¶çš„å¤„ç†ã€‚

#### âœ…ä»£ç ä¼˜ç‚¹ï¼š
1. **åŠŸèƒ½æ‰©å±•**ï¼šæ·»åŠ äº†å¯¹ä»»åŠ¡æ¡ä»¶ã€ä»»åŠ¡è¯¦æƒ…ä»¥åŠæ–°çš„ä»»åŠ¡ç±»å‹çš„æ”¯æŒï¼ŒåŠŸèƒ½æ›´ä¸ºå®Œå¤‡ã€‚
2. **é‡ç”¨æ€§æé«˜**ï¼šé€šè¿‡å¼•å…¥é€šç”¨æœåŠ¡å’Œæ–¹æ³•ï¼Œå¦‚`UserTaskService`ä¸­çš„`exectuteTaskForAttribute`æ–¹æ³•ï¼Œæå‡äº†ä»£ç çš„å¯é‡ç”¨æ€§ã€‚
3. **ä»£ç ç»„ç»‡è‰¯å¥½** ï¼šä»£ç ç»“æ„è‰¯å¥½ï¼Œæ¨¡å—åˆ†å±‚æ˜ç¡®ã€‚

#### ğŸ¤”é—®é¢˜ç‚¹ï¼š
1. **ä»£ç é‡å¤**ï¼šå­˜åœ¨é‡å¤ä»£ç ç‰‡æ®µï¼Œç‰¹åˆ«æ˜¯åœ¨ä»»åŠ¡æ¡ä»¶çš„å¤„ç†éƒ¨åˆ†ï¼Œå¯ä»¥è€ƒè™‘æŠ½å–å…¬å…±é€»è¾‘ã€‚
2. **æ½œåœ¨èµ„æºæ³„éœ²**ï¼šéƒ¨åˆ†æ–¹æ³•æœªè€ƒè™‘èµ„æºçš„é‡Šæ”¾ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠæ•°æ®åº“è¿æ¥å’Œå¤–éƒ¨èµ„æºè°ƒç”¨çš„éƒ¨åˆ†ã€‚
3. **ç¼ºå°‘å¼‚å¸¸å¤„ç†**ï¼šæ–°æ·»åŠ çš„æ–¹æ³•ä¸­å¯¹å¤–éƒ¨ä¾èµ–çš„è°ƒç”¨ç¼ºå°‘å¿…è¦çš„å¼‚å¸¸å¤„ç†ã€‚
4. **å‘½åä¸è§„èŒƒ**ï¼šæŸäº›å˜é‡å‘½åã€æ–¹æ³•å‘½åä¸å¤Ÿè§„èŒƒï¼Œå¦‚`userTaskisList`åº”ä¸º`userTaskList`ã€‚
5. **æ³¨é‡Šä¸è¶³**ï¼šå…³é”®é€»è¾‘ç¼ºå°‘æ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯å¤æ‚çš„ä»»åŠ¡å¤„ç†éƒ¨åˆ†ï¼Œç¼ºå°‘å¯¹å®ç°é€»è¾‘çš„è¯¦ç»†è¯´æ˜ã€‚
6. **æ—¥å¿—è¾“å‡º**ï¼šå¤§é‡çš„`System.out.println`åº”æ›¿æ¢ä¸ºæ—¥å¿—è®°å½•ï¼Œæ–¹ä¾¿ç”Ÿäº§ç¯å¢ƒä¸­çš„é—®é¢˜æ’æŸ¥ã€‚

#### ğŸ¯ä¿®æ”¹å»ºè®®ï¼š
1. **é‡æ„ä»£ç æå–å…¬å…±é€»è¾‘**ï¼š
    é‡æ„é‡å¤ä»£ç ï¼Œæå–å…¬å…±é€»è¾‘åˆ°ç‹¬ç«‹çš„æ–¹æ³•ä¸­ã€‚
2. **è¡¥å……èµ„æºé‡Šæ”¾å’Œå¼‚å¸¸å¤„ç†**ï¼š
    é’ˆå¯¹æ•°æ®åº“è¿æ¥å’Œå¤–éƒ¨èµ„æºè®¿é—®æ·»åŠ å¿…è¦çš„èµ„æºé‡Šæ”¾å’Œå¼‚å¸¸å¤„ç†é€»è¾‘ã€‚
3. **è§„èŒƒå‘½å**ï¼š
    ç»Ÿä¸€å˜é‡å’Œæ–¹æ³•å‘½åï¼Œéµå¾ªé©¼å³°å‘½åæ³•å’Œç»Ÿä¸€çš„å‘½åè§„èŒƒã€‚
4. **è¡¥å……æ³¨é‡Š**ï¼š
    åœ¨å…³é”®é€»è¾‘å¤„æ·»åŠ å¿…è¦çš„æ³¨é‡Šï¼Œå°¤å…¶æ˜¯å¯¹äºå¤æ‚çš„æ–¹æ³•ï¼Œå¢åŠ å¯¹å®ç°çš„è¯´æ˜ã€‚
5. **ä½¿ç”¨æ—¥å¿—è®°å½•**ï¼š
    æ›¿æ¢`System.out.println`ä¸ºæ—¥å¿—è®°å½•ï¼Œä¾¿äºçº¿ä¸Šé—®é¢˜çš„æ’æŸ¥å’Œè¿ç»´ã€‚

#### ğŸ’»ä¿®æ”¹åçš„ä»£ç ï¼š
```java
public class UserRoleController extends AbstractHandler {

    @Autowired
    private RedisTemplate redisTemplate;
    @Autowired
    private UserTaskService userTaskService;
    @Autowired
    private TaskCondService taskCondService;
    @Autowired
    private DungeonService dungeonService;

    private static final String ROOM_KEY_PREFIX = "room";
    private static final ObjectMapper objectMapper = new ObjectMapper();

    // å…¶ä»–æ–¹æ³•çœç•¥...

    private Result handleUserRoleProps(String role_no) {
        ResultUserRoleProps resultUserRoleProps = userRoleService.findUserRoleProps(role_no, (Integer) session.getAttributes().get("rid"), is);
        resultUserRoleProps.setAvatar(avatar); // ç”¨æˆ·å¤´åƒ
        resultUserRoleProps.setIsRole(isRole); // æ˜¯å¦ä¸ºå½“å‰è§’è‰²
        
        List<UserTask> taskList = userTaskService.findUserTasks(new UserTask(role_no, 10, 4));
        logger.info("è·å¾—è§’è‰²çš„å¾…å®Œæˆä»»åŠ¡: {}", taskList);

        taskList.forEach(task -> {
            if (task.getTaskFinishType().equals(10)) {
                List<TaskCond> taskConds = taskCondService.findTaskCondByTaskIdRoleNo(role_no, task.getTaskId());
                logger.info("è·å¾—è§’è‰²çš„ä»»åŠ¡éœ€æ±‚: {}", taskConds);
                userTaskService.executeTaskForAttribute(taskConds, resultUserRoleProps, role_no, task.getTaskId());
            }
        });

        return new Result(ResultCode.SUCCESS, resultUserRoleProps);
    }
}

// è¡¥å……æ³¨é‡Šå’Œå¼‚å¸¸å¤„ç†åçš„ UserTaskServiceImpl ç±»
@Service
public class UserTaskServiceImpl implements UserTaskService {

    @Autowired
    private UserTaskMapper userTaskMapper;
    @Autowired
    private TaskCondMapper taskCondMapper;

    // å…¶ä»–æ–¹æ³•çœç•¥...

    @Override
    @Transactional
    public void executeTaskForAttribute(List<TaskCond> taskConds, ResultUserRoleProps resultUserRoleProps, Integer roleNo, Integer taskId) {
        int completedConditions = 0;
        
        for (TaskCond taskCond : taskConds) {
            try {
                switch (taskCond.getCondId()) {
                    case 1001:
                        taskCond.setFinishNumber((int) resultUserRoleProps.getHP());
                        break;
                    case 1002:
                        taskCond.setFinishNumber(resultUserRoleProps.getScore());
                        break;
                    default:
                        logger.warn("æœªçŸ¥çš„ä»»åŠ¡æ¡ä»¶ID: {}", taskCond.getCondId());
                        continue;
                }

                if (taskCond.getFinishNumber() >= taskCond.getNeedNumber()) {
                    taskCond.setFinish(1);
                    completedConditions++;
                }

                taskCondMapper.updateTaskCond(taskCond);
                logger.info("æ›´æ–°åçš„ä»»åŠ¡æ¡ä»¶: {}", taskCond);

                if (completedConditions == taskConds.size()) {
                    UserTask userTask = new UserTask();
                    userTask.setTaskNo(taskCond.getTaskNo());
                    userTask.setState(4);
                    userTaskMapper.updateUserTask(userTask);
                    updateFollowUpTasks(roleNo, taskId);
                }
            } catch (Exception e) {
                logger.error("å¤„ç†ä»»åŠ¡æ¡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {}", taskCond, e);
            }
        }
    }
}
```

è¿™æ ·ä¸ä»…æå‡äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†ä»£ç çš„ç¨³å¥æ€§å’Œå®‰å…¨æ€§ã€‚